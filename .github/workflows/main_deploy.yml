name: Build, Test and Deploy Buzzlings #The name of the workflow that appears in the GitHub Actions UI

on:
  push:
    branches:
      - main #Every time you push code to the main branch, the process starts automatically
  workflow_dispatch: #This adds the manual "Run Workflow" button in the GitHub UI

permissions:
  id-token: write #This is required for requesting the JWT
  contents: read  #This is required for actions/checkout
  packages: write #Required to push the Docker image to GitHub Container Registry

jobs: #Workflows are divided into jobs
  build-and-test: #The ID of our first job
    name: Build & Run Tests 
    runs-on: ubuntu-latest #We are asking GitHub for a fresh Linux virtual machine to run our code

    steps: #The sequence of commands the machine will follow
      - name: Checkout Code
        uses: actions/checkout@v4 #The machine starts empty. This "clones" the repository into the virtual machine so it can see the .sln and .csproj files.

      - name: Setup .NET
        uses: actions/setup-dotnet@v4 #Installs the .NET SDK. We specified 9.0.x to match the project
        with:
          dotnet-version: '9.0.x'

      - name: Restore Dependencies
        run: dotnet restore Buzzlings.sln #Downloads all the NuGet packages (dependencies) for every project in the solution

      - name: Build Solution
        run: dotnet build Buzzlings.sln --no-restore --configuration Release #Compiles the entire solution. --no-restore speeds it up because we just did it. Release mode optimizes the code for production

      - name: Run Unit Tests
        #Runs all tests in the tests/Buzzlings.Tests folder
        #SQLite tests work out of the box on the runner
        run: dotnet test Buzzlings.sln --no-build --configuration Release --verbosity normal #It runs all tests in tests/Buzzlings.Tests/. Because we use SQLite, it creates the DB file in the machine's RAM, runs the tests, and deletes it. If any test fails, the workflow stops here and won't deploy.

  deploy:
    name: Deploy to Azure
    needs: build-and-test #Only runs if tests pass, this is critical. It tells GitHub: "Do not start the deployment unless the Build and Test job finished successfully."
    runs-on: ubuntu-latest #A second fresh machine is used for the deployment phase
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4 #We need the source code again on this fresh machine to build the Docker image

      - name: Login to Azure
        uses: azure/login@v2 #This is where the machine "logs in" to our Azure account
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Login to GHCR
        #Authenticate with GitHub's registry using the automatic GITHUB_TOKEN provided by the runner
        uses: docker/login-action@v3 
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Image
        #This step builds the image using your Dockerfile and pushes it to GHCR
        run: | #The "|" is a Block Scalar Header, which defines everything below this line (and indented) as one single block of text
          #Create a variable with the full image path (owner name must be lowercase)
          IMAGE_PATH=ghcr.io/${{ github.repository_owner }}/buzzlings-web
          
          #Build the image and tag it with both the unique Run ID and 'latest'
          docker build -t $IMAGE_PATH:${{ github.run_id }} -t $IMAGE_PATH:latest .
          
          #Push all tags to GitHub Container Registry
          docker push $IMAGE_PATH --all-tags

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3 #The final act.
        with:
          app-name: 'app-buzzlings-web-brazilsouth-prod-001' #Tells Azure exactly which "slot" or website to overwrite.
          #Point to the GitHub Container Registry image using the unique run_id to force a fresh pull
          images: 'ghcr.io/${{ github.repository_owner }}/buzzlings-web:${{ github.run_id }}'