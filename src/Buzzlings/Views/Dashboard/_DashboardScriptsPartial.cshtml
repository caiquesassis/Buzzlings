<script>
    let lastLogIndex = 0;
    let isRequestPending = false;
    const statusIntervalTimer = 6000;

    function filterBuzzlingsTable() {
        document.getElementById("searchInput").addEventListener("input", function () {
            var searchTerm = this.value;

            $.ajax({
                url: "@Url.Action("FilterBuzzlings", "Dashboard")",
                type: "GET",
                data: { query: searchTerm },
                success: function (data) {
                    document.getElementById("buzzlingsTable").innerHTML = data;
                },
                error: function(xhr, status, error) {
                    console.error("Error filtering buzzlings table: ", error);
                }
            });
        });
    }

    function refreshBuzzlingsTable() {
        $.ajax({
            url: "@Url.Action("GetBuzzlingsTablePartial", "Dashboard")",
            type: "GET",
            success: function(data) {
                //If we have something in the searchbar, do not update the table
                if(document.getElementById("searchInput").value.length === 0) {
                    document.getElementById("buzzlingsTable").innerHTML = data;
                }
            },
            error: function(xhr, status, error) {
                console.error("Error refreshing buzzlings table: ", error);
            }
        });
    }

    function addEventLog(message) {
        var logContainer = document.getElementById("eventLog");

        var logEntry = document.createElement("div");
        logEntry.innerHTML = message; //Assuming the message can contain HTML for rich text

        logContainer.appendChild(logEntry);

        //Scroll to the bottom (for auto-scrolling)
        logContainer.scrollTop = logContainer.scrollHeight;
    }

    function updateHiveStatus(isInitialLoad = false) {
        if (isRequestPending) {
            console.warn("Tick suppressed: Previous request still pending.");
            return;
        }

        isRequestPending = true;

        $.ajax({
            url: "@Url.Action("UpdateHiveStatus", "Dashboard")",
            type: "GET",
            data: {
                lastLogIndex: lastLogIndex,
                isInitialLoad: isInitialLoad
            },
            timeout: 10000,
            success: function (data) {
                //Fetch latest logs
                if (data.log && data.log.length > 0) {
                    data.log.forEach(logMessage => addEventLog(logMessage));
                    lastLogIndex = data.lastLogIndex;
                }

                refreshBuzzlingsTable();

                document.getElementById("hiveHappiness").innerHTML = "Happiness: " + data.happiness + "%";
                document.getElementById("hiveAge").innerHTML = "Age: " + data.age;
                document.getElementById("hiveAgeDescription").innerHTML = data.age !== 1 ? "<b> days old | </b>" : "<b> day old | </b>";

                if(data.happiness <= 0) {
                    handleSimulationEnd(data.age);
                }
            },
            error: function(xhr, status, error) {
                console.error("Error updating hive status: ", error);
            },
            complete: function(xhr) {
                isRequestPending = false;

                const data = xhr.responseJSON;

                // Schedule next tick if simulation is still active (or if request failed)
                if (!data || data.happiness > 0) {
                    setTimeout(function() { updateHiveStatus(false); }, statusIntervalTimer);
                }
            }
        });
    }

    function handleSimulationEnd(age) {
        $.ajax({
            url: "@Url.Action("FinalizeHive", "Dashboard")",
            type: "POST",
            headers: {
                //This grabs the hidden input generated by @Html.AntiForgeryToken()
                //We need the token because this is a POST request with [ValidateAntiForgeryToken]
                "RequestVerificationToken": $('input[name="__RequestVerificationToken"]').val()
            },
            success: function() {
                document.getElementById("hiveAgeSimulationEnd").innerHTML = age;
                document.getElementById("overlay-panel").classList.add("show");
                document.body.classList.add("no-scroll");
            },
            error: function(xhr) {
                console.error("FinalizeHive failed with status: " + xhr.status);
            }
        });
    }

    $(document).ready(function() {
        //This id will only be found if the user has a Hive and it gets rendered
        //We only want to run updateHiveStatus if a Hive is not null
        //A bit hacky, not the best, but it works
        if(document.getElementById("simulationdiv")) {
            updateHiveStatus(true);
        }
    });

    window.onbeforeunload = function() {
        isRequestPending = true; //Block any further simulation ticks when leaving page
    };

</script>