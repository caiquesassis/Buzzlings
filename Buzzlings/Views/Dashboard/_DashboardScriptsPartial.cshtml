<script>
    let lastLogIndex = 0;
    let hiveAge = @Model.User?.Hive?.Age;
    let happinessIntervalId;
    const happinessIntervalTimer = 6000;
    const ageIntervalTimer = 6000;

    function filterBuzzlingsTable() {
        document.getElementById("searchInput").addEventListener("input", function () {
            var searchTerm = this.value;

            $.ajax({
                url: "@Url.Action("FilterBuzzlings", "Dashboard")",
                type: "GET",
                data: { query: searchTerm },
                success: function (data) {
                    document.getElementById("buzzlingsTable").innerHTML = data;
                }
            });
        });
    }

    function refreshBuzzlingsTable() {
        $.ajax({
            url: "@Url.Action("GetBuzzlingsTablePartial", "Dashboard")",
            type: "GET",
            success: function(data) {
                //If we have something in the searchbar, do not update the table
                if(document.getElementById("searchInput").value.length === 0) {
                    document.getElementById("buzzlingsTable").innerHTML = data;
                }
            }
        });
    }

    function addEventLog(message) {
        var logContainer = document.getElementById("eventLog");

        var logEntry = document.createElement("div");
        logEntry.innerHTML = message; // Assuming the message can contain HTML for rich text

        logContainer.appendChild(logEntry);

        // Scroll to the bottom (for auto-scrolling)
        logContainer.scrollTop = logContainer.scrollHeight;
    }

    function fetchLatestLogs() {
        $.ajax({
            url: "@Url.Action("GetEventLog", "Dashboard")",
            type: "GET",
            data: { lastLogIndex: lastLogIndex },  // Send the index of the last log entry
            success: function(data) {
                if (data && data.log && data.log.length > 0) {
                    data.log.forEach(logMessage => {
                        addEventLog(logMessage);
                    });
                }

                lastLogIndex = data.lastLogIndex;
            },
            error: function(xhr, status, error) {
                console.error("Error fetching logs: ", error);
            }
        });
    }

    function updateHiveAge() {
        $.ajax({
            url: "@Url.Action("UpdateHiveAge", "Dashboard")",
            type: "GET",
            success: function (data) {
                hiveAge = data.age;
                document.getElementById("hiveAge").innerHTML = "Age: " + data.age;
            }
        });
    }

    function updateHiveHappiness() {
        $.ajax({
            url: "@Url.Action("UpdateHiveHappiness", "Dashboard")",
            type: "GET",
            success: function (data) {
                fetchLatestLogs();
                refreshBuzzlingsTable();
                document.getElementById("hiveHappiness").innerHTML = "Happiness: " + data.happiness + "%";
            }
        });
    }

    $(document).ready(function() {
        fetchLatestLogs();
        filterBuzzlingsTable();
        setInterval(updateHiveAge, ageIntervalTimer);
        setInterval(updateHiveHappiness, happinessIntervalTimer);
    });

</script>