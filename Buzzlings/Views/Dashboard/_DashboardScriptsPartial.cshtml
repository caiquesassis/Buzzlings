<script>
    let lastLogIndex = 0;
    let hiveAge = @Model.User?.Hive?.Age;
    const statusIntervalTimer = 6000;

    function filterBuzzlingsTable() {
        document.getElementById("searchInput").addEventListener("input", function () {
            var searchTerm = this.value;

            $.ajax({
                url: "@Url.Action("FilterBuzzlings", "Dashboard")",
                type: "GET",
                data: { query: searchTerm },
                success: function (data) {
                    document.getElementById("buzzlingsTable").innerHTML = data;
                },
                error: function(xhr, status, error) {
                    console.error("Error filtering buzzlings table: ", error);
                }
            });
        });
    }

    function refreshBuzzlingsTable() {
        $.ajax({
            url: "@Url.Action("GetBuzzlingsTablePartial", "Dashboard")",
            type: "GET",
            success: function(data) {
                //If we have something in the searchbar, do not update the table
                if(document.getElementById("searchInput").value.length === 0) {
                    document.getElementById("buzzlingsTable").innerHTML = data;
                }
            },
            error: function(xhr, status, error) {
                console.error("Error refreshing buzzlings table: ", error);
            }
        });
    }

    function addEventLog(message) {
        var logContainer = document.getElementById("eventLog");

        var logEntry = document.createElement("div");
        logEntry.innerHTML = message; // Assuming the message can contain HTML for rich text

        logContainer.appendChild(logEntry);

        // Scroll to the bottom (for auto-scrolling)
        logContainer.scrollTop = logContainer.scrollHeight;
    }

    function fetchLatestLogs() {
        $.ajax({
            url: "@Url.Action("GetEventLog", "Dashboard")",
            type: "GET",
            data: { lastLogIndex: lastLogIndex },
            success: function(data) {
                if (data && data.log && data.log.length > 0) {
                    data.log.forEach(logMessage => {
                        addEventLog(logMessage);
                    });
                }

                lastLogIndex = data.lastLogIndex;
            },
            error: function(xhr, status, error) {
                console.error("Error fetching logs: ", error);
            }
        });
    }

    function updateHiveStatus() {
        $.ajax({
            url: "@Url.Action("UpdateHiveStatus", "Dashboard")",
            type: "GET",
            success: function (data) {
                fetchLatestLogs();
                refreshBuzzlingsTable();
                document.getElementById("hiveHappiness").innerHTML = "Happiness: " + data.happiness + "%";
                document.getElementById("hiveAge").innerHTML = "Age: " + data.age;
                document.getElementById("hiveAgeDescription").innerHTML = data.age !== 1 ? "<b> days old | </b>" : "<b> day old | </b>";

                if(data.happiness <= 0) {
                    handleSimulationFailure();
                } else {
                    //Schedule the next update ONLY after this one is done
                    //This prevents syncing errors that happen with setInterval
                    setTimeout(updateHiveStatus, statusIntervalTimer);
                }
            },
            error: function(xhr, status, error) {
                console.error("Error updating hive status: ", error);
            }
        });
    }

    function handleSimulationFailure() {
        clearInterval(happinessIntervalId);
        clearInterval(ageIntervalId);

        document.getElementById("overlay-panel").classList.add("show");
        document.body.classList.add("no-scroll");

        $.ajax({
            url: "@Url.Action("DeleteHiveOnSimulationEnd", "Dashboard")",
            type: "POST"
        });
    }

    $(document).ready(function() {
        fetchLatestLogs();
        filterBuzzlingsTable();
        setTimeout(updateHiveStatus, statusIntervalTimer);
    });

</script>